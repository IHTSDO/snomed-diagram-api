#!/bin/bash
set -e

# Create application user if it doesn't exist
if ! id "snomed-diagram" &>/dev/null; then
    useradd --system --shell /bin/false --home-dir /opt/snomed-diagram-api snomed-diagram
fi

# Set proper ownership
chown -R snomed-diagram:snomed-diagram /opt/snomed-diagram-api

# Install npm dependencies
cd /opt/snomed-diagram-api
if [ -f package.json ]; then
    npm install --production
fi

# Reload supervisor configuration
if command -v supervisorctl >/dev/null 2>&1; then
    supervisorctl reread
    supervisorctl update
    supervisorctl start snomed-diagram-api || true
fi



echo "SNOMED Diagram API installed successfully!"
echo "Service will be available at http://localhost:3000"
echo "Use 'supervisorctl status snomed-diagram-api' to check service status"
